#!/bin/bash

punt() {
    local url="$1"

    local file=$(basename "$url")
    local variable=${file//-/_}_data; local value
    
    [[ -z ${!variable} ]] && {
        if value="$(curl --proto '=https' -sSf "$url")"; then
            eval "$variable=\"\$value\""
        else
            msg --error "Failed to transfer data from $url"
        fi
    }

    shift && [[ -n $@ ]] && punt $@
}

parse() {
    local command=$1

    case $command in
        install|uninstall|config)
            local ferry=$2

            local dock_dir="$HOME/.charon/dock"; mkdir -p "$dock_dir"
            local dock_file="$dock_dir/$ferry"; touch "$dock_file"
            local dock_data="$(cat "$dock_file")"
            local ferry_data="$(
                curl --proto '=https' -sSf "$charon_raw_url/ferries/$ferry"
            )"

            create_object $ferry "$abstract_ferry_data"
            create_object $ferry "$ferry_data"
            create_object $ferry "$dock_data"

            type ${ferry}_uninstall | sed -n '2,$p' > "$dock_file"

            ${ferry}_${command}

            local log_file="$HOME/.charon/all-programs"

            if ! grep -q "^$ferry$" "$log_file"; then
                echo "$ferry" >> "$log_file"
            fi
            
            shift 2 && [[ -n $@ ]] && parse $command $@
        ;;
        --help|-h)
            curl --proto '=https' -sSf "$charon_raw_url/usage"
        ;;
        *)
            msg --unknown-command "$command"
        ;;
    esac
}

main() {
    local charon_api_url="https://api.github.com/repos/skeletony007/charon/contents"
    local charon_raw_url="https://raw.githubusercontent.com/skeletony007/charon/main"
    local bash_utils_raw_url="https://raw.githubusercontent.com/skeletony007/bash-utils/main"
    local dotfiles_raw_url="https://raw.githubusercontent.com/skeletony007/.dotfiles/main"

    eval "$(
        curl --proto '=https' -sSf \
            "$charon_raw_url/colors" \
            "$charon_raw_url/messages" \
            "$bash_utils_raw_url/object/object" \
            "$bash_utils_raw_url/shell-functions/shell-functions"
    )"

    local gh_wrapper_data="$( \
        curl --proto '=https' -sSf "$charon_raw_url/punts/gh-wrapper"
    )"

    create_object charon "$gh_wrapper_data"

    punt $( \
        charon_get_api_data download_url "$charon_api_url/punts" \
    )

    parse $@
}

main $@

