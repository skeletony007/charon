#!/bin/bash

report() {
    local exit_status=$?

    local error
    local info

    for arg in "$@"; do
        case "$1" in
            -e|--error)
                error="$2"
                ;;
            -i|--info)
                info="$2"
                ;;
        esac
        shift 2
    done

    if [ "$exit_status" -ne 0 ] && [ -n "$error" ]; then
        echo -e "${RED}ERROR${NC}  $error" >&2
    elif [ -n "$info" ]; then
        echo -e "${GREEN}INFO${NC}   $info"
    fi

    return "$exit_status"
}

secure_curl() {
    local URL="$1"
    
    curl --proto '=https' -sSf "$URL" >(report -e)
    report -e "Failed to transfer data from ${YELLOW}$URL${NC}"
}

eval_curl() {
    local URL="$1"

    local data="$(secure_curl "$URL")"
    eval "$data"
    report -e "Failed to evaluate data from ${YELLOW}$URL${NC}"
}

ROOT_URL="https://raw.githubusercontent.com/skeletony007/charon/main"
BASH_UTILS_URL="https://raw.githubusercontent.com/skeletony007/bash-utils/main"

eval_curl "$ROOT_URL/colors"
eval_curl "$BASH_UTILS_URL/object/object"

abstract_ferry="$(secure_curl "$ROOT_URL/punts/abstract-ferry")"


action=$1

case $action in
    install|uninstall|config)
        shift
        for ferry in "$@"; do
            ferry_data="$(secure_curl "$ROOT_URL/ferries/$ferry")"

            create_object $ferry "$abstract_ferry"
            create_object $ferry "$ferry_data"

            ${ferry}_${action}
            report -e "$action failed" \
                   -i "$action succeeded"
        done
    ;;
    --help|-h)
        secure_curl "$ROOT_URL/usage"
    ;;
    *)
        echo -e "Invalid command or missing arguments. Use ${YELLOW}charon --help${NC} for usage instructions."
    ;;
esac

