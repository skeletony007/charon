#!/bin/bash

scanl() {
    local function="$1"
    local num_args=$2

    $function "${@:3:$num_args}"
    [ $? -ne 0 ] && {
        msg --error "Failed evaluation: $function \"${@:3:$num_args}\""
    }

    shift $((2 + $num_args)) && [[ -n $@ ]] && scanl "$function" $num_args "$@"
}

punt() {
    local url="$1"

    local file=$(basename "$url")
    local variable=$(tr '[:lower:]' '[:upper:]' <<< ${file//-/_})_DATA; local value

    [[ -z ${!variable} ]] && {
        if value="$(curl --proto '=https' -sSf "$url")"; then
            eval "$variable=\"\$value\""
        else
            msg --error "Failed to transfer data from $url"
            return 1
        fi
    } || return 0
}

parse() {
    local command=$1

    case $command in
        install|uninstall|config)
            local ferry=$2

            if [[ "$1" == *' '* ]]; then
                msg --warning 'Operation stopped: Program names must not contain spaces'
                return 1
            fi

            local ferry_data="$(
                curl --proto '=https' -sSf "$charon_raw_url/ferries/$ferry"
            )"
            local dock_data="$(
                cache_read dock/$ferry
            )"

            create_object $ferry "$ABSTRACT_FERRY_DATA
                                  $ferry_data
                                  $dock_data"

            ${ferry}_${command}
            local exit_status=$?

            if [ $exit_status -ne 0 ]; then
                if [ $command == install ]; then
                    parse uninstall $ferry
                fi
                msg --warning "$(tr '[:lower:]' '[:upper:]' <<< ${command:0:1})${command:1} failed: charon $command $ferry"
                return 1
            elif [ $command == install ] || [ $command == uninstall ]; then
                local uninstall_data="$(
                    type ${ferry}_uninstall | sed -n '2,$p'
                )"

                local direction

                case $command in
                    install)
                        direction=write    
                    ;;
                    uninstall)
                        direction=delete
                    ;;
                esac

                scanl cache_$direction 2 \
                    all-programs $ferry \
                    dock/$ferry "$uninstall_data"
            fi

            return 0
            ;;
        --help|-h)
            curl --proto '=https' -sSf "$charon_raw_url/usage"
            ;;
        *)
            msg --unknown-command "$command"
            return 1
            ;;
    esac
}

main() {
    local charon_api_url="https://api.github.com/repos/skeletony007/charon/contents"
    local charon_raw_url="https://raw.githubusercontent.com/skeletony007/charon/main"
    local bash_utils_raw_url="https://raw.githubusercontent.com/skeletony007/bash-utils/main"
    local dotfiles_raw_url="https://raw.githubusercontent.com/skeletony007/.dotfiles/main"

    eval "$(
        curl --proto '=https' -sSf \
            "$bash_utils_raw_url/object/object" \
            "$bash_utils_raw_url/shell-functions/shell-functions"
    )"

    local cache_data="$( \
        curl --proto '=https' -sSf "$charon_raw_url/cache"
    )"
    create_object cache "$cache_data" "$HOME/.charon"

    GH_WRAPPER_DATA="$( \
        curl --proto '=https' -sSf "$charon_raw_url/punts/gh-wrapper"
    )"
    create_object charon "$GH_WRAPPER_DATA"
    
    scanl punt 1 $( 
        charon_get_api_data download_url "$charon_api_url/punts"
    )

    eval "$COLORS_DATA
          $MESSAGES_DATA"

    scanl "parse $1" 1 ${@:2}
}

main $@

